<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#f8f8f5">
    <title>LUOCHA : OFFLINE</title>
    
    <!-- 스타일 & 아이콘 로드 (Tailwind, Lucide, Fonts) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&family=Space+Mono:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">

    <style>
        /* 기본 설정 */
        :root {
            --bg-color: #f8f8f5;
            --text-color: #1a1a1a;
            --accent-color: #0000ff;
        }
        body { 
            background-color: var(--bg-color); 
            color: var(--text-color);
            font-family: 'Inter', sans-serif;
            overflow: hidden; /* 앱 같은 느낌을 위해 스크롤 제어 */
            user-select: none; /* 앱 느낌 */
        }
        
        /* 폰트 유틸리티 */
        .font-serif { font-family: 'Playfair Display', serif; }
        .font-mono { font-family: 'Space Mono', monospace; }
        
        /* 커스텀 스크롤바 (숨김 처리하지만 스크롤은 가능) */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

        /* 화면 전환 효과 */
        .view-section { 
            display: none; 
            height: 100%; 
            opacity: 0; 
            animation: fadeIn 0.4s ease-out forwards;
        }
        .view-section.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* 타자기 커서 효과 */
        .cursor-blink::after { content: '|'; animation: blink 1s step-end infinite; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }

        /* 심연(Abyss) 물결 효과 */
        .abyss-water {
            transition: height 1s linear, background 1s ease;
            mask-image: linear-gradient(to bottom, transparent, black 20%);
            -webkit-mask-image: linear-gradient(to bottom, transparent, black 20%);
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        editorial: { bg: '#f8f8f5', text: '#1a1a1a', accent: '#0000ff', highlight: '#ccff00', muted: '#888888' }
                    }
                }
            }
        }
    </script>
<script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "@google/genai": "https://aistudiocdn.com/@google/genai@^1.30.0",
    "lucide-react": "https://aistudiocdn.com/lucide-react@^0.555.0"
  }
}
</script>
</head>
<body class="h-[100dvh] flex flex-col md:flex-row">

    <!-- [NAV] 네비게이션 바 (모바일:하단, 데스크탑:좌측) -->
    <nav class="z-50 w-full md:w-24 md:h-full h-20 bg-white border-t-2 md:border-t-0 md:border-r-2 border-black flex md:flex-col justify-between items-center px-6 md:px-0 fixed bottom-0 md:relative pb-[env(safe-area-inset-bottom)] pt-2 md:pt-6">
        <!-- 로고 -->
        <div class="hidden md:block font-serif font-bold text-2xl tracking-widest rotate-180 writing-vertical text-center mb-6 text-black">LUOCHA</div>
        
        <!-- 메뉴 아이템 컨테이너 -->
        <div class="flex md:flex-col justify-between w-full md:w-auto md:space-y-12">
            <button onclick="app.nav('dashboard')" id="nav-dashboard" class="nav-btn group p-2 text-black transition-transform active:scale-95">
                <i data-lucide="square" width="24"></i>
                <span class="hidden md:block absolute left-14 bg-black text-white text-[10px] px-2 py-1 opacity-0 group-hover:opacity-100 font-mono">ATELIER</span>
            </button>
            <button onclick="app.nav('protocol')" id="nav-protocol" class="nav-btn group p-2 text-gray-400 hover:text-black transition-colors active:scale-95">
                <i data-lucide="list-todo" width="24"></i>
                <span class="hidden md:block absolute left-14 bg-black text-white text-[10px] px-2 py-1 opacity-0 group-hover:opacity-100 font-mono">PROTOCOL</span>
            </button>
            <button onclick="app.nav('focus')" id="nav-focus" class="nav-btn group p-2 text-gray-400 hover:text-black transition-colors active:scale-95">
                <i data-lucide="zap" width="24"></i>
                <span class="hidden md:block absolute left-14 bg-black text-white text-[10px] px-2 py-1 opacity-0 group-hover:opacity-100 font-mono">FOCUS</span>
            </button>
            <button onclick="app.nav('journal')" id="nav-journal" class="nav-btn group p-2 text-gray-400 hover:text-black transition-colors active:scale-95">
                <i data-lucide="file-text" width="24"></i>
                <span class="hidden md:block absolute left-14 bg-black text-white text-[10px] px-2 py-1 opacity-0 group-hover:opacity-100 font-mono">ARCHIVE</span>
            </button>
        </div>

        <div class="hidden md:block text-[9px] font-mono text-gray-300 -rotate-90 whitespace-nowrap mb-4">OFFLINE.MODE</div>
    </nav>

    <!-- [MAIN] 메인 컨텐츠 영역 -->
    <main class="flex-1 overflow-hidden relative h-full bg-editorial-bg">
        <div class="w-full h-full p-5 md:p-8 max-w-5xl mx-auto pb-24 md:pb-10 overflow-y-auto scrollbar-hide">
            
            <!-- 1. DASHBOARD: ATELIER -->
            <section id="view-dashboard" class="view-section active flex-col gap-6">
                <header class="border-b-2 border-black pb-4 flex justify-between items-end">
                    <div>
                        <h2 class="font-mono text-xs text-gray-500 uppercase tracking-widest mb-1">Status Report</h2>
                        <h1 class="font-serif text-5xl md:text-7xl font-bold leading-none">The Atelier</h1>
                    </div>
                    <div class="text-right">
                        <div id="current-date" class="font-serif italic text-lg border-b border-black inline-block"></div>
                        <div class="font-mono text-[10px] bg-black text-white inline-block px-1 mt-1">VOL. LOCAL</div>
                    </div>
                </header>

                <!-- 체크인 -->
                <div class="border border-black bg-white p-5 shadow-sm">
                    <h3 class="font-mono text-[10px] text-gray-400 uppercase mb-4">Daily Existence Check</h3>
                    <div class="flex gap-3 mb-4">
                        <button onclick="app.toggleCheckIn('AM')" id="btn-am" class="flex-1 py-4 border border-gray-200 hover:border-black transition-all flex flex-col items-center gap-2">
                            <i data-lucide="sun" width="16"></i>
                            <span class="font-mono text-[10px] font-bold">AM OPEN</span>
                        </button>
                        <button onclick="app.toggleCheckIn('PM')" id="btn-pm" class="flex-1 py-4 border border-gray-200 hover:border-black transition-all flex flex-col items-center gap-2">
                            <i data-lucide="moon" width="16"></i>
                            <span class="font-mono text-[10px] font-bold">PM CLOSE</span>
                        </button>
                    </div>
                    <div id="checkin-message" class="hidden bg-gray-50 p-3 border-l-2 border-blue-600 text-sm font-serif italic text-gray-800"></div>
                </div>

                <!-- 오늘의 인용구 (DB에서 랜덤 로드) -->
                <div class="border border-black bg-white p-6 shadow-sm flex flex-col gap-4 relative mt-auto md:mt-0">
                    <span class="absolute top-0 left-0 bg-black text-white text-[10px] font-mono px-2 py-1">INSIGHT</span>
                    <p id="quote-text" class="font-serif text-2xl md:text-3xl italic mt-4 leading-snug">"Loading..."</p>
                    <p id="quote-author" class="font-mono text-xs text-right text-gray-400 uppercase"></p>
                    <div class="border-t border-gray-100 pt-3">
                        <p class="font-sans text-sm text-gray-500"><span class="font-bold text-black">나찰:</span> <span id="quote-comment"></span></p>
                    </div>
                </div>
            </section>

            <!-- 2. PROTOCOL: TASKS (분리된 뷰) -->
            <section id="view-protocol" class="view-section flex-col h-full">
                <header class="border-b-2 border-black pb-4 mb-6">
                    <h2 class="font-mono text-xs text-gray-500 uppercase tracking-widest mb-1">Action Directives</h2>
                    <h1 class="font-serif text-5xl md:text-6xl font-bold leading-none">The Protocol</h1>
                </header>

                <div class="flex flex-col gap-4 h-full">
                    <!-- 퀵 액션 버튼들 -->
                    <div class="flex flex-wrap gap-2">
                        <button onclick="app.addQuickMission('RESET')" class="px-3 py-2 border border-black bg-white hover:bg-black hover:text-white transition-colors font-mono text-[10px] flex items-center gap-2">
                            <i data-lucide="refresh-cw" width="12"></i> ENV. RESET
                        </button>
                        <button onclick="app.addQuickMission('BODY')" class="px-3 py-2 border border-black bg-white hover:bg-black hover:text-white transition-colors font-mono text-[10px] flex items-center gap-2">
                            <i data-lucide="activity" width="12"></i> BODY SCAN
                        </button>
                        <button onclick="app.addQuickMission('MIND')" class="px-3 py-2 border border-black bg-white hover:bg-black hover:text-white transition-colors font-mono text-[10px] flex items-center gap-2">
                            <i data-lucide="brain" width="12"></i> MIND CLEAR
                        </button>
                    </div>

                    <!-- 입력창 -->
                    <div class="flex border border-black bg-white shadow-sm shrink-0">
                        <input type="text" id="task-input" placeholder="새로운 지령 입력..." 
                               class="flex-1 p-4 font-mono text-sm outline-none bg-transparent"
                               onkeydown="if(event.key === 'Enter') app.addTask()">
                        <button onclick="app.addTask()" class="px-6 bg-black text-white hover:bg-blue-700 transition-colors">
                            <i data-lucide="plus" width="20"></i>
                        </button>
                    </div>

                    <!-- 태스크 리스트 -->
                    <div id="task-list" class="flex-1 overflow-y-auto space-y-3 pb-20 pr-1">
                        <!-- JS로 주입됨 -->
                    </div>
                </div>
            </section>

            <!-- 3. FOCUS: TIMER -->
            <section id="view-focus" class="view-section flex-col h-full relative">
                <!-- 심연 배경 효과 -->
                <div id="abyss-bg" class="absolute bottom-0 left-0 w-full bg-gradient-to-t from-blue-900 to-black opacity-20 abyss-water pointer-events-none z-0" style="height: 0%;"></div>

                <div class="relative z-10 flex flex-col h-full justify-between py-6">
                    <div class="text-center">
                        <h2 class="font-serif text-3xl italic">The Ritual</h2>
                        <p id="focus-status" class="font-mono text-[10px] text-gray-500 tracking-[0.2em] mt-2">DOPAMINE DETOX</p>
                    </div>

                    <!-- 타이머 디스플레이 -->
                    <div class="flex-1 flex flex-col items-center justify-center">
                        <div id="timer-display" class="font-mono text-[18vw] md:text-[8rem] leading-none tracking-tighter select-none tabular-nums">25:00</div>
                    </div>

                    <!-- 컨트롤러 -->
                    <div class="flex flex-col items-center gap-8 mb-8">
                        <div class="flex items-center gap-6">
                            <button onclick="timer.toggle()" id="btn-timer-toggle" class="w-16 h-16 rounded-full border-2 border-black flex items-center justify-center hover:bg-black hover:text-white transition-all">
                                <i data-lucide="play" width="24" id="icon-play"></i>
                                <i data-lucide="pause" width="24" id="icon-pause" class="hidden"></i>
                            </button>
                            <button onclick="timer.reset()" class="w-10 h-10 rounded-full border border-gray-300 text-gray-400 flex items-center justify-center hover:border-black hover:text-black transition-all">
                                <i data-lucide="rotate-ccw" width="16"></i>
                            </button>
                        </div>

                        <!-- 모드 선택 -->
                        <div class="flex gap-2 bg-white/50 p-1 rounded-full border border-gray-200">
                            <button onclick="timer.setMode('FOCUS')" class="timer-mode-btn px-4 py-1 rounded-full text-[10px] font-mono font-bold bg-black text-white transition-all" data-mode="FOCUS">FOCUS</button>
                            <button onclick="timer.setMode('REST')" class="timer-mode-btn px-4 py-1 rounded-full text-[10px] font-mono text-gray-400 hover:text-black transition-all" data-mode="REST">REST</button>
                        </div>
                    </div>
                </div>

                <!-- 완료 피드백 모달 (숨김) -->
                <div id="timer-feedback" class="hidden absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-80 bg-white border-2 border-black p-6 text-center shadow-[4px_4px_0px_0px_black] z-50">
                    <p id="timer-msg" class="font-serif italic text-lg mb-4"></p>
                    <button onclick="timer.closeFeedback()" class="bg-black text-white px-4 py-2 font-mono text-xs hover:bg-blue-700">ACKNOWLEDGED</button>
                </div>
            </section>

            <!-- 4. JOURNAL: ARCHIVE + CBT -->
            <section id="view-journal" class="view-section flex-col h-full gap-4">
                <header class="flex justify-between items-end border-b-2 border-black pb-4 shrink-0">
                    <h1 class="font-serif text-5xl">The Archive</h1>
                    <div class="flex gap-2">
                        <button onclick="journal.openCBT()" class="flex items-center gap-2 bg-editorial-accent text-white px-3 py-1.5 font-mono text-xs hover:bg-blue-700 transition-colors">
                            <i data-lucide="brain-circuit" width="14"></i>
                            <span class="hidden md:inline">DISSECT</span>
                        </button>
                    </div>
                </header>

                <div class="flex-1 flex flex-col md:flex-row gap-6 overflow-hidden">
                    <!-- 입력 영역 -->
                    <div class="flex-1 flex flex-col h-full">
                        <textarea id="journal-input" 
                                  class="w-full h-full p-6 bg-white border border-gray-200 resize-none outline-none font-serif text-lg leading-relaxed placeholder:text-gray-300 placeholder:italic focus:border-black transition-colors"
                                  placeholder="지금 당신을 괴롭히는 것은 사실입니까, 감정입니까?"></textarea>
                    </div>

                    <!-- 분석 결과 영역 -->
                    <div id="journal-analysis-box" class="hidden md:flex md:w-1/3 border-t md:border-t-0 md:border-l border-black pt-4 md:pt-0 md:pl-6 flex-col overflow-y-auto">
                        <span class="font-mono text-[10px] text-gray-400 uppercase tracking-widest mb-2">Analysis Result</span>
                        <h3 id="analysis-title" class="font-serif text-2xl italic text-blue-800 mb-4"></h3>
                        <div id="analysis-body" class="font-sans text-sm leading-7 text-gray-700 space-y-4"></div>
                        <div class="mt-8 text-right font-mono text-xs text-gray-400">-- LUOCHA SYSTEM</div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <!-- [MODAL] CBT 인지왜곡 선택 팝업 -->
    <div id="cbt-modal" class="hidden fixed inset-0 z-[100] bg-white/90 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-lg border-2 border-black shadow-[8px_8px_0px_0px_rgba(0,0,0,1)] flex flex-col max-h-[70vh] animate-[fadeIn_0.2s_ease-out]">
            
            <!-- 헤더 -->
            <div class="flex justify-between items-center p-5 border-b border-gray-100 bg-gray-50 shrink-0">
                <div>
                    <h3 class="font-serif text-xl italic font-bold">Cognitive Dissection</h3>
                    <p class="font-mono text-[10px] text-gray-500 mt-1">인지 오류를 선택하여 해부하십시오.</p>
                </div>
                <button onclick="journal.closeCBT()" class="hover:text-red-500"><i data-lucide="x" width="24"></i></button>
            </div>

            <!-- 리스트 (스크롤 가능) -->
            <div class="overflow-y-auto p-2" id="cbt-options">
                <!-- 옵션들이 JS로 주입됩니다 -->
            </div>
        </div>
    </div>

    <!-- 스크립트: 루오차 엔진 (Internal Brain) -->
    <script>
        // ---------------------------------------------------------
        // [DATABASE] 나찰의 스크립트 & CBT 처방전 (사용자 수정 가능)
        // ---------------------------------------------------------
        const LUOCHA_DB = {
            quotes: [
                { text: "나가는 유일한 길은 통과하는 것뿐입니다.", author: "Robert Frost", comment: "피하지 마십시오. 정면으로 뚫고 나가야 합니다." },
                { text: "혼돈은 해독되기를 기다리는 질서일 뿐입니다.", author: "José Saramago", comment: "지금의 어지러움도 결국 정리될 것입니다." },
                { text: "완벽함이 아니라, 탁월함을 추구하십시오.", author: "Unknown", comment: "당신을 갉아먹는 완벽주의를 버리십시오." },
                { text: "감정은 날씨와 같습니다. 지나갑니다.", author: "Mindfulness", comment: "비가 온다고 하늘이 무너지지는 않습니다." }
            ],
            checkIn: {
                AM: [
                    "오셨군요. 세상은 시끄럽지만, 우리는 질서를 만듭니다.",
                    "오늘의 활력 징후 양호. 시작하십시오.",
                    "감정을 배제하고 사실만 보십시오. 당신은 유능합니다.",
                    "준비되셨습니까? 우아하게 처리해버리죠."
                ],
                PM: [
                    "고생하셨습니다. 이제 가면을 벗고 쉬십시오.",
                    "오늘의 거래 종료. 남은 근심은 제게 넘기시죠.",
                    "충분히 견뎌냈습니다. 스스로를 용서하고 주무십시오.",
                    "심연도 잠들 시간입니다. 눈을 감으세요."
                ]
            },
            missions: {
                RESET: ["책상 위 불필요한 물건 하나 폐기.", "창문 열고 3분 환기.", "지갑 영수증 정리.", "이불 정리."],
                BODY: ["물 한 잔 원샷.", "어깨 힘 빼기.", "척추 펴기.", "눈 감고 1분 대기."],
                MIND: ["불안한 생각 적고 줄 그어 지우기.", "2분 멍때리기.", "좋아하는 향 맡기."]
            },
            // CBT/ACT 처방전 (키: 인지왜곡 ID)
            cbtPrescriptions: {
                'ALL_OR_NOTHING': {
                    title: "회색지대의 발견",
                    diagnosis: "당신은 지금 '완벽하지 않으면 쓰레기'라고 생각하고 있군요.",
                    away: "실패가 두려워 아예 시작조차 안 하거나, 도망치고 있습니다.",
                    towards: "100점이 아니어도 괜찮습니다. 10점짜리 행동이라도 지금 바로 하십시오."
                },
                'CATASTROPHIZING': {
                    title: "유령과의 싸움",
                    diagnosis: "일어나지 않은 최악의 미래를 상상하며 떨고 있습니다.",
                    away: "끊임없는 걱정으로 현재의 평온을 희생하고 있습니다.",
                    towards: "'지금 당장' 내 발밑을 보세요. 당신은 안전합니다. 호흡하십시오."
                },
                'SHOULD': {
                    title: "족쇄 풀기",
                    diagnosis: "'반드시 ~해야 한다'는 규칙으로 스스로를 고문하고 있습니다.",
                    away: "죄책감 때문에 진정으로 원하는 것을 억누르고 있습니다.",
                    towards: "'해야 한다'를 '하고 싶다'로 바꿔보십시오. 아니면, 그냥 하지 마십시오."
                },
                'LABELING': {
                    title: "존재와 행위의 분리",
                    diagnosis: "일시적인 실수를 당신의 영원한 정체성으로 착각하고 있습니다.",
                    away: "자신을 비난하느라 다시 일어설 힘을 낭비하고 있습니다.",
                    towards: "당신은 '실패자'가 아니라, '실패를 경험한 사람'일 뿐입니다. 다시 하세요."
                }
            }
        };

        const DISTORTIONS = [
            { id: 'ALL_OR_NOTHING', label: '흑백논리', desc: '모 아니면 도. 중간은 없다.' },
            { id: 'CATASTROPHIZING', label: '파국화', desc: '최악의 상황만 상상하기.' },
            { id: 'SHOULD', label: '당위적 사고', desc: '반드시 ~해야만 해.' },
            { id: 'LABELING', label: '낙인찍기', desc: '난 구제 불능이야.' }
        ];

        // ---------------------------------------------------------
        // [APP] 어플리케이션 로직
        // ---------------------------------------------------------
        const app = {
            state: {
                view: 'dashboard',
                tasks: [],
                checkIn: { am: false, pm: false }
            },

            init() {
                this.loadData();
                this.renderDashboard();
                this.renderTasks();
                this.nav('dashboard');
                lucide.createIcons();
                
                // 날짜 설정
                const d = new Date();
                document.getElementById('current-date').innerText = 
                    `${d.getFullYear()}.${String(d.getMonth()+1).padStart(2,'0')}.${String(d.getDate()).padStart(2,'0')}`;
            },

            loadData() {
                const savedTasks = localStorage.getItem('luocha_tasks');
                if (savedTasks) this.state.tasks = JSON.parse(savedTasks);
            },

            nav(viewId) {
                // 탭 활성화 UI
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('text-black'));
                document.getElementById(`nav-${viewId}`).classList.add('text-black');
                
                // 뷰 전환
                document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
                document.getElementById(`view-${viewId}`).classList.add('active');
                
                // 모바일 아이콘 색상 보정
                if(viewId !== 'dashboard') {
                   document.getElementById(`nav-${viewId}`).classList.remove('text-gray-400');
                }
                
                this.state.view = viewId;
            },

            // --- DASHBOARD ---
            renderDashboard() {
                // 랜덤 명언
                const q = LUOCHA_DB.quotes[Math.floor(Math.random() * LUOCHA_DB.quotes.length)];
                document.getElementById('quote-text').innerText = `"${q.text}"`;
                document.getElementById('quote-author').innerText = `- ${q.author}`;
                document.getElementById('quote-comment').innerText = q.comment;
            },

            toggleCheckIn(type) {
                const btn = document.getElementById(`btn-${type.toLowerCase()}`);
                const msgBox = document.getElementById('checkin-message');
                const isChecked = !this.state.checkIn[type.toLowerCase()];
                
                this.state.checkIn[type.toLowerCase()] = isChecked;

                if (isChecked) {
                    btn.classList.add('bg-black', 'text-white', 'border-black');
                    const msgs = LUOCHA_DB.checkIn[type];
                    msgBox.innerText = `"${msgs[Math.floor(Math.random() * msgs.length)]}"`;
                    msgBox.classList.remove('hidden');
                } else {
                    btn.classList.remove('bg-black', 'text-white', 'border-black');
                    msgBox.classList.add('hidden');
                }
            },

            // --- PROTOCOL (TASKS) ---
            renderTasks() {
                const list = document.getElementById('task-list');
                list.innerHTML = '';
                
                this.state.tasks.forEach((task, idx) => {
                    const el = document.createElement('div');
                    el.className = 'group flex items-center justify-between p-4 bg-white border border-gray-200 hover:border-black transition-all';
                    el.innerHTML = `
                        <div class="flex items-center gap-3">
                            <button onclick="app.toggleTask(${idx})" class="w-5 h-5 border border-black flex items-center justify-center ${task.done ? 'bg-black' : ''}">
                                ${task.done ? '<i data-lucide="check" class="text-white w-3"></i>' : ''}
                            </button>
                            <div>
                                <div class="font-mono text-sm ${task.done ? 'line-through opacity-30' : 'font-bold'}">${task.text}</div>
                                <div class="text-[10px] text-blue-600 font-serif italic">${task.motivation || '지금 처리하십시오.'}</div>
                            </div>
                        </div>
                        <button onclick="app.deleteTask(${idx})" class="text-gray-300 hover:text-red-500"><i data-lucide="x" width="16"></i></button>
                    `;
                    list.appendChild(el);
                });
                lucide.createIcons();
                localStorage.setItem('luocha_tasks', JSON.stringify(this.state.tasks));
            },

            addTask() {
                const input = document.getElementById('task-input');
                if (!input.value.trim()) return;
                
                this.state.tasks.unshift({ text: input.value, done: false, motivation: "망설이지 말고 실행하십시오." });
                input.value = '';
                this.renderTasks();
            },

            addQuickMission(category) {
                const pool = LUOCHA_DB.missions[category];
                const mission = pool[Math.floor(Math.random() * pool.length)];
                this.state.tasks.unshift({ text: `${category}: ${mission}`, done: false, motivation: "작은 질서가 큰 평온을 만듭니다." });
                this.renderTasks();
            },

            toggleTask(idx) {
                this.state.tasks[idx].done = !this.state.tasks[idx].done;
                this.renderTasks();
            },

            deleteTask(idx) {
                this.state.tasks.splice(idx, 1);
                this.renderTasks();
            }
        };

        // ---------------------------------------------------------
        // [TIMER] 포커스 타이머 로직
        // ---------------------------------------------------------
        const timer = {
            time: 1500, // 25분
            total: 1500,
            active: false,
            interval: null,
            mode: 'FOCUS',

            format(s) {
                return `${Math.floor(s/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`;
            },

            setMode(m) {
                this.mode = m;
                this.reset();
                this.time = (m === 'FOCUS') ? 1500 : 300;
                this.total = this.time;
                document.getElementById('timer-display').innerText = this.format(this.time);
                
                document.querySelectorAll('.timer-mode-btn').forEach(b => {
                    if(b.dataset.mode === m) {
                        b.classList.remove('bg-white', 'text-gray-400');
                        b.classList.add('bg-black', 'text-white');
                    } else {
                        b.classList.add('text-gray-400');
                        b.classList.remove('bg-black', 'text-white');
                    }
                });

                // 배경 색상 힌트
                const bg = document.getElementById('abyss-bg');
                if(m === 'REST') bg.className = "absolute bottom-0 left-0 w-full bg-gradient-to-t from-emerald-800 to-black opacity-30 abyss-water pointer-events-none z-0";
                else bg.className = "absolute bottom-0 left-0 w-full bg-gradient-to-t from-blue-900 to-black opacity-30 abyss-water pointer-events-none z-0";
            },

            toggle() {
                if (this.active) this.pause();
                else this.start();
            },

            start() {
                this.active = true;
                document.getElementById('icon-play').classList.add('hidden');
                document.getElementById('icon-pause').classList.remove('hidden');
                
                this.interval = setInterval(() => {
                    this.time--;
                    this.updateUI();
                    if (this.time <= 0) this.complete();
                }, 1000);
            },

            pause() {
                this.active = false;
                clearInterval(this.interval);
                document.getElementById('icon-play').classList.remove('hidden');
                document.getElementById('icon-pause').classList.add('hidden');
            },

            reset() {
                this.pause();
                this.time = (this.mode === 'FOCUS') ? 1500 : 300;
                this.updateUI();
            },

            updateUI() {
                document.getElementById('timer-display').innerText = this.format(this.time);
                // 물 높이 조절
                const percent = ((this.total - this.time) / this.total) * 100;
                document.getElementById('abyss-bg').style.height = `${percent}%`;
            },

            complete() {
                this.pause();
                const fb = document.getElementById('timer-feedback');
                const msg = document.getElementById('timer-msg');
                fb.classList.remove('hidden');
                
                if(this.mode === 'FOCUS') msg.innerText = "몰입이 끝났습니다. 당신의 세계가 조금 더 깊어졌군요.";
                else msg.innerText = "휴식이 끝났습니다. 다시 현실로 돌아오십시오.";
            },

            closeFeedback() {
                document.getElementById('timer-feedback').classList.add('hidden');
                this.reset();
            }
        };

        // ---------------------------------------------------------
        // [JOURNAL] 저널링 & CBT 엔진
        // ---------------------------------------------------------
        const journal = {
            openCBT() {
                const modal = document.getElementById('cbt-modal');
                const container = document.getElementById('cbt-options');
                container.innerHTML = '';

                // 왜곡 유형 리스트 생성
                DISTORTIONS.forEach(d => {
                    const btn = document.createElement('button');
                    btn.className = "w-full text-left p-4 mb-2 border hover:border-black hover:bg-gray-50 transition-colors flex flex-col";
                    btn.innerHTML = `
                        <span class="font-bold font-sans text-sm">${d.label}</span>
                        <span class="text-xs text-gray-500">${d.desc}</span>
                    `;
                    btn.onclick = () => this.analyze(d.id);
                    container.appendChild(btn);
                });

                modal.classList.remove('hidden');
            },

            closeCBT() {
                document.getElementById('cbt-modal').classList.add('hidden');
            },

            analyze(distortionId) {
                this.closeCBT();
                
                // 로딩 효과 흉내
                const titleEl = document.getElementById('analysis-title');
                const bodyEl = document.getElementById('analysis-body');
                const box = document.getElementById('journal-analysis-box');
                const boxMobile = document.getElementById('view-journal'); // 모바일에서 스크롤 위로

                box.classList.remove('hidden');
                box.classList.add('flex');
                
                titleEl.innerText = "분석 중...";
                bodyEl.innerHTML = "";

                setTimeout(() => {
                    const result = LUOCHA_DB.cbtPrescriptions[distortionId] || LUOCHA_DB.cbtPrescriptions['ALL_OR_NOTHING'];
                    
                    titleEl.innerText = result.title;
                    bodyEl.innerHTML = `
                        <div class="mb-4">
                            <strong class="block font-mono text-xs text-blue-600 mb-1">DIAGNOSIS (인지)</strong>
                            ${result.diagnosis}
                        </div>
                        <div class="mb-4">
                            <strong class="block font-mono text-xs text-red-500 mb-1">AWAY MOVE (회피)</strong>
                            ${result.away}
                        </div>
                        <div>
                            <strong class="block font-mono text-xs text-green-600 mb-1">TOWARDS MOVE (전진)</strong>
                            ${result.towards}
                        </div>
                    `;
                }, 800);
            }
        };

        // 초기화 실행
        window.addEventListener('DOMContentLoaded', () => app.init());

    </script>
</body>
</html>
